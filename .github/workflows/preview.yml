name: Preview Home Page â€” Build

on:
  workflow_dispatch:
  pull_request:

# Only one build per PR branch at a time.
concurrency:
  group: 'preview-build-${{ github.head_ref }}'
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          submodules: recursive
          fetch-depth: 0

      - uses: pnpm/action-setup@v4
        name: Install pnpm
        with:
          version: 9

      - name: Build
        env:
          NEXT_PUBLIC_HOME_URL: https://fastgpt.io
          NEXT_PUBLIC_USER_URL: https://cloud.fastgpt.io
        run: |
          pnpm install
          pnpm run build

      # Save PR number so the deploy workflow knows which PR to comment on.
      - name: Save PR metadata
        run: echo "${{ github.event.pull_request.number }}" > ./out/pr-number.txt

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: preview-build
          path: ./out
          retention-days: 1
